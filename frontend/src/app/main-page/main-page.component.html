<div class="grid">
  <div class="leftGrid">
    <div class="planList">
      <table
        mat-table
        [dataSource]="this.plans()">
        <ng-container matColumnDef="id">
          <th
            mat-header-cell
            *matHeaderCellDef>
            ID
          </th>
          <td
            mat-cell
            *matCellDef="let plan">
            <span class="boldSpan">{{ plan.id }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="plans">
          <th
            mat-header-cell
            *matHeaderCellDef>
            # Plans
          </th>
          <td
            mat-cell
            *matCellDef="let plan">
            {{ plan.graphNodesStats.plan }}
          </td>
        </ng-container>

        <ng-container matColumnDef="columns">
          <th
            mat-header-cell
            *matHeaderCellDef>
            # Columns
          </th>
          <td
            mat-cell
            *matCellDef="let plan">
            {{ plan.graphNodesStats.column + plan.graphNodesStats.filter_column }}
          </td>
        </ng-container>

        <ng-container matColumnDef="filters">
          <th
            mat-header-cell
            *matHeaderCellDef>
            # Filters
          </th>
          <td
            mat-cell
            *matCellDef="let plan">
            {{ plan.graphNodesStats.filter_column }}
          </td>
        </ng-container>

        <ng-container matColumnDef="preds">
          <th
            mat-header-cell
            *matHeaderCellDef>
            # Logical Predicates
          </th>
          <td
            mat-cell
            *matCellDef="let plan">
            {{ plan.graphNodesStats.logical_pred_ }}
          </td>
        </ng-container>

        <ng-container matColumnDef="tables">
          <th
            mat-header-cell
            *matHeaderCellDef>
            # Tables
          </th>
          <td
            mat-cell
            *matCellDef="let plan">
            {{ plan.graphNodesStats.table }}
          </td>
        </ng-container>

        <tr
          mat-header-row
          *matHeaderRowDef="displayedPlanColumns(); sticky: true"></tr>
        <tr
          mat-row
          *matRowDef="let plan; columns: displayedPlanColumns()"
          [class]="['planListItem', this.selectedPlan() && this.selectedPlan()!.id == plan.id ? 'selected' : '']"
          (click)="onPlanSelected(plan)"></tr>
      </table>
    </div>
    <div class="leftBottomGrid">
      @if (this.selectedPlan()) {
        <!-- <button
          mat-raised-button
          color="primary"
          (click)="onPredictClick()">
          Predict
        </button> -->
        <mat-form-field subscriptSizing="dynamic">
          <mat-label>Explainer</mat-label>
          <mat-select [(value)]="selectedExplainer">
            <mat-option [value]="explainerType.gradient">Gradient</mat-option>
            <mat-option [value]="explainerType.guidedBackpropagation">Guided Backpropagation</mat-option>
          </mat-select>
        </mat-form-field>
        <button
          mat-raised-button
          color="primary"
          (click)="onExplainClick()">
          Explain
        </button>
      }
      @if (this.selectedPlanPrediction()) {
        <div class="flexColumn">
          <p>
            <span class="boldSpan">Label: </span>
            <span>{{ this.selectedPlanPrediction()?.label | number: '1.0-2' }}</span>
          </p>
          <p>
            <span class="boldSpan">Prediction: </span>
            <span>{{ this.selectedPlanPrediction()?.prediction | number: '1.0-2' }}</span>
          </p>
        </div>
      }
      @if (this.nodeImportancesSorted()) {
        <div class="flexColumn">
          @for (node of this.nodeImportancesSorted(); track node.node.nodeId) {
            @if (node.importance) {
              <p
                [class]="['nodeImportanceItem', this.selectedNode() && this.selectedNode()!.nodeId == node.node.nodeId ? 'selected' : '']"
                (click)="selectedNode.set(node.node)">
                <span class="boldSpan">{{ node.node.label }}: </span>
                <span>{{ node.importance | percent }}</span>
                <span class="boldSpan"> = </span>
                <span>{{ node.value | number: '1.0-2' }}</span>
              </p>
            }
          }
        </div>
      }
    </div>
  </div>
  <div class="rightGrid">
    <div class="graphBlock">
      @if (this.selectedFullPlan()) {
        <app-plan-graph
          [graph]="this.selectedFullPlan()"
          [explanation]="this.selectedPlanExplanation()"
          [(selectedNode)]="selectedNode"></app-plan-graph>
      }
    </div>
    @if (this.selectedNode(); as selectedNode) {
      <div class="nodeInfo">
        <p>
          <span class="boldSpan">{{ selectedNode.label }}</span>
          @if (this.selectedNodeImportance(); as nodeImportance) {
            <span>: </span>
            <span>{{ nodeImportance.importance | percent }}</span>
            <span class="boldSpan"> = </span>
            <span>{{ nodeImportance.value | number: '1.0-2' }}</span>
          }
        </p>
        <div class="nodeInfoList">
          <table
            mat-table
            [dataSource]="this.selectedNodeInfoFields()">
            <ng-container matColumnDef="attr">
              <th
                mat-header-cell
                *matHeaderCellDef>
                Attribute
              </th>
              <td
                mat-cell
                *matCellDef="let nodeInfo">
                <span class="boldSpan">{{ nodeInfo.name }}</span>
              </td>
            </ng-container>
            <ng-container matColumnDef="value">
              <th
                mat-header-cell
                *matHeaderCellDef>
                Value
              </th>
              <td
                mat-cell
                *matCellDef="let nodeInfo">
                {{ nodeInfo.value }}
              </td>
            </ng-container>
            <ng-container matColumnDef="isFeature">
              <th
                mat-header-cell
                *matHeaderCellDef>
                Is Feature
              </th>
              <td
                mat-cell
                *matCellDef="let nodeInfo">
                {{ nodeInfo.isFeature }}
              </td>
            </ng-container>
            <ng-container matColumnDef="importance">
              <th
                mat-header-cell
                *matHeaderCellDef>
                Importance
              </th>
              <td
                mat-cell
                *matCellDef="let nodeInfo">
                {{ nodeInfo.importance ? (nodeInfo.importance | percent) : '' }}
              </td>
            </ng-container>
            <tr
              mat-header-row
              *matHeaderRowDef="displayedNodeColumns(); sticky: true"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: displayedNodeColumns()"></tr>
          </table>
        </div>
      </div>
    }
  </div>
</div>
